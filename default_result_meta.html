<html>
<head lang="en">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta charset="utf-8">
    <title>Application</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Bootstrap Template">
    <meta name="Mark Stacy" content="OU IT Informatics">
    <link rel="stylesheet" href="bower_components/boostrap_style/flatly/bootstrap.min.css">
    <!--<link rel="stylesheet" href="http://mgmic.oscer.ou.edu/portal/style.css">-->
</head>
<body style="padding:5px;">
  <div class="panel panel-default" >
  <!-- Default panel contents -->
    <div class="panel-heading"><b>Workflow Status</b> <span style="float:right;"></span></div>
      <table class="table table-striped table-condensed" style="border-radius:10px;">
    <!--<thead>
      <tr>
        <th>Workflow</th>
        <th>Status</th>
      </tr>
    </thead>-->
      <tbody>
        <tr id="qc"class="" style="margin:1px;">
          <td id="task_name" class="col-sm-4" >Quality Control</td>
          <td class="">WAITING </td>
        </tr>
      </tbody>
      </table>
    </div>
    <div id="task_result"></div>
    <div>
        <a href="#" onclick="$('#details').toggle('slow');"><b>Workflow Parameters</b></a>
        <div id="details" style="display: none;"></div>
    </div>
</body>
<script src="bower_components/jquery/dist/jquery.min.js"></script>
<script type="text/javascript" src="bower_components/bootstrap/dist/js/bootstrap.min.js"></script>
<script type="text/javascript" src="bower_components/handlebars/handlebars.runtime.min.js"></script>
<script src="jquery.form.js"></script>
<!--<script src="api.js"></script>-->
<script src="templates.js"></script>
<script>
$(function() {
    qs = $.parseQuerystring();
    $('#qc td:first').text(qs.task_name)
    $('.panel-heading span').text(" Task ID: " + qs.task_id )
    total_fgs=0;curent_fgs=0;
    poll_url = "/api/queue/task/" + qs.task_id + "/.json";
    result_obj=null;
    poll();
});
function set_workflow_status(id,data){
    temp = Handlebars.templates['tmpl-status']
    $('#' + id + " td:nth-child(2)").html(temp(data))
}
function poll() {
       $.ajax({ url:poll_url , success: function(data) {
            //console.log(data);
            $("#details").empty();
            $("#details").append("<pre>" + JSON.stringify(data,null, 2) + "</pre>")
            if (data.result.status=="PENDING"){
                $('#task_result').empty();
                $('#task_result').append("<pre>" + JSON.stringify(data.result,null, 4) + "</pre>")
                set_workflow_status('qc',{status:data.result.status,progress_display:"inline",success_display:"none"})
                setTimeout(function() { poll(); }, 3000);
            }else{
                if (data.result.status=="SUCCESS"){
                  set_workflow_status('qc',{status:data.result.status,progress_display:"none",success_display:"inline"})
                  $('#qc').addClass("success")
                  //subtask_poll(data)
                }else{
                  set_workflow_status('qc',{status:data.result.status,progress_display:"none",success_display:"none"})
                  $('#qc').addClass("danger")
                }
                $('#task_result').empty();
                temp = data.result;
                delete temp.children;
                result_obj=temp;
                $('#task_result').append("<pre>" + JSON.stringify(temp,null, 2) + "</pre>");
                $('#task_result').urlize();
            }
       }});
}
jQuery.fn.urlize = function() {
    if (this.length > 0) {
        this.each(function(i, obj){
            // making links active
            var x = $(obj).html();
            var list = x.match( /\b(http:\/\/|www\.|http:\/\/www\.)[^ <]{2,200}\b/g );
            if (list) {
                for ( i = 0; i < list.length; i++ ) {
                    var prot = list[i].indexOf('http://') === 0 || list[i].indexOf('https://') === 0 ? '' : 'http://';
                    x = x.replace( list[i], "<a target='_blank' href='" + prot + list[i] + "'>"+ list[i] + "</a>" );
                }

            }
            $(obj).html(x);
        });
    }
};
jQuery.extend({
    parseQuerystring: function() {
        var nvpair = {};
        var qs = window.location.search.replace('?', '');
        var pairs = qs.split('&');
        $.each(pairs, function(i, v) {
            var pair = v.split('=');
            nvpair[pair[0]] = pair[1];
        });
        return nvpair;
    }
});
</script>
</hmtl>
